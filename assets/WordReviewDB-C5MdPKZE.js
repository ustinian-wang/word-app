import{d as W,e as R,o as l}from"./WordRecordDB-CUDRBFFc.js";import{r as p}from"./request-BN4A8ICA.js";function I(){return{EF:2.5,interval:0,repetitions:0}}function T({EF:s,interval:t,repetitions:i},a){return a?(i+=1,i===1?t=1:i===2?t=6:t=Math.round(t*s),s=Math.min(2.5,s+.1)):(i=0,t=1,s=Math.max(1.3,s-.2)),{EF:s,interval:t,repetitions:i}}function c(s){return p.get("/api/wordSm2/upsertData",{params:s})}const N={INITIAL_EF:2.5},e={WORD:"word",EF:"EF",INTERVAL:"interval",REPETITIONS:"repetitions",NEXT_REVIEW:"next_review"};class m{constructor(){this.dbName="wordReviewDB",this.storeName="words",this.db=null,this.version=3}async init(){return this.db?this.db:(this.db=await l(this.dbName,this.version,{upgrade(t){t.objectStoreNames.contains("words")||t.createObjectStore("words",{keyPath:e.WORD}).createIndex(e.NEXT_REVIEW,e.NEXT_REVIEW,{unique:!1})}}),this.db)}async addWord(t){const i={[e.WORD]:t,[e.EF]:N.INITIAL_EF,[e.INTERVAL]:0,[e.REPETITIONS]:0,[e.NEXT_REVIEW]:Date.now()};return await this.init(),this.putWord(i)}async putWord(t){return await this.init(),this.db.put(this.storeName,t)}async getTodayWords(){return await this.init(),this.getWordsToReview(new Date)}async getWordsToReview(t=null){await this.init();const a=this.db.transaction(this.storeName,"readonly").store.index(e.NEXT_REVIEW);if(t){const r=t;r.setHours(0,0,0,0);const n=r.getTime();r.setHours(23,59,59,999);const o=r.getTime();return a.getAll(window.IDBKeyRange.bound(n,o))}else return[]}async processReview(t,i){await this.init();let a=await this.getWord(t)||I();const{[e.EF]:r,[e.INTERVAL]:n,[e.REPETITIONS]:o}=a;let{EF:h,interval:w,repetitions:E}=T({EF:r,interval:n,repetitions:o},!!i);const d={...a,[e.EF]:h,[e.INTERVAL]:w,[e.REPETITIONS]:E,[e.NEXT_REVIEW]:Date.now()+n*24*60*60*1e3,[e.WORD]:t};return console.log("updatedWordData",d),await this.putWord(d),d}async importWord(t){return await this.init(),await this.getWord(t[e.WORD])?await this.putWord(t):await this.addWord(t[e.WORD])}async getWord(t){return await this.init(),this.db.get(this.storeName,t)}async getWords(t){return await this.init(),await Promise.all(t.map(i=>this.getWord(i)))}async getAllWords(){return await this.init(),this.db.getAll(this.storeName)}async deleteWord(t){return await this.init(),this.db.delete(this.storeName,t)}}const u=new m;u.init();async function f(s,t){return R(s,t),c({word:s,pass:0,bid:t}),await u.processReview(s,1)}async function y(s,t){return W(s,t),c({word:s,pass:0,bid:t}),await u.processReview(s,0)}export{y as f,f as p,u as w};
