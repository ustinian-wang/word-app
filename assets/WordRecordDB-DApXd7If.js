import{r as f}from"./request-DLDTzHiv.js";const g=(t,e)=>e.some(n=>t instanceof n);let S,P;function j(){return S||(S=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function U(){return P||(P=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const b=new WeakMap,y=new WeakMap,w=new WeakMap;function V(t){const e=new Promise((n,r)=>{const a=()=>{t.removeEventListener("success",i),t.removeEventListener("error",s)},i=()=>{n(l(t.result)),a()},s=()=>{r(t.error),a()};t.addEventListener("success",i),t.addEventListener("error",s)});return w.set(e,t),e}function k(t){if(b.has(t))return;const e=new Promise((n,r)=>{const a=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",s),t.removeEventListener("abort",s)},i=()=>{n(),a()},s=()=>{r(t.error||new DOMException("AbortError","AbortError")),a()};t.addEventListener("complete",i),t.addEventListener("error",s),t.addEventListener("abort",s)});b.set(t,e)}let p={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return b.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return l(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function L(t){p=t(p)}function _(t){return U().includes(t)?function(...e){return t.apply(A(this),e),l(this.request)}:function(...e){return l(t.apply(A(this),e))}}function G(t){return typeof t=="function"?_(t):(t instanceof IDBTransaction&&k(t),g(t,j())?new Proxy(t,p):t)}function l(t){if(t instanceof IDBRequest)return V(t);if(y.has(t))return y.get(t);const e=G(t);return e!==t&&(y.set(t,e),w.set(e,t)),e}const A=t=>w.get(t);function K(t,e,{blocked:n,upgrade:r,blocking:a,terminated:i}={}){const s=indexedDB.open(t,e),d=l(s);return r&&s.addEventListener("upgradeneeded",o=>{r(l(s.result),o.oldVersion,o.newVersion,l(s.transaction),o)}),n&&s.addEventListener("blocked",o=>n(o.oldVersion,o.newVersion,o)),d.then(o=>{i&&o.addEventListener("close",()=>i()),a&&o.addEventListener("versionchange",u=>a(u.oldVersion,u.newVersion,u))}).catch(()=>{}),d}const Y=["get","getKey","getAll","getAllKeys","count"],H=["put","add","delete","clear"],I=new Map;function M(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(I.get(e))return I.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,a=H.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(a||Y.includes(n)))return;const i=async function(s,...d){const o=this.transaction(s,a?"readwrite":"readonly");let u=o.store;return r&&(u=u.index(d.shift())),(await Promise.all([u[n](...d),a&&o.done]))[0]};return I.set(e,i),i}L(t=>({...t,get:(e,n,r)=>M(e,n)||t.get(e,n,r),has:(e,n)=>!!M(e,n)||t.has(e,n)}));const q=["continue","continuePrimaryKey","advance"],N={},B=new WeakMap,x=new WeakMap,$={get(t,e){if(!q.includes(e))return t[e];let n=N[e];return n||(n=N[e]=function(...r){B.set(this,x.get(this)[e](...r))}),n}};async function*z(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,$);for(x.set(n,e),w.set(n,A(e));e;)yield n,e=await(B.get(n)||e.continue()),B.delete(n)}function W(t,e){return e===Symbol.asyncIterator&&g(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&g(t,[IDBIndex,IDBObjectStore])}L(t=>({...t,get(e,n,r){return W(e,n)?z:t.get(e,n,r)},has(e,n){return W(e,n)||t.has(e,n)}}));function O(t){return f.get("/api/wordRecord/addWordRecord",{params:t})}function X(t){return f.get("/api/wordRecord/getLearnResByTime",{params:t})}function Z(t){return f.get("/api/wordRecord/getNextLearningWords",{params:t})}function ee(t){return f.get("/api/wordRecord/getTodayReviewWords",{params:t})}const h={FAIL:0,PASS:1},m={LEARNING:0,REVIEW:1},c={WORD:"word",TIMESTAMP:"timestamp",STATUS:"status",UID:"uid",TYPE:"type"};class J{constructor(){this.dbName="wordAppRecordDB",this.storeName="wordRecords",this.version=1}async initDB(){return K(this.dbName,this.version,{upgrade(e){if(!e.objectStoreNames.contains("wordRecords")){const n=e.createObjectStore("wordRecords",{keyPath:"id",autoIncrement:!0});n.createIndex("timestamp","timestamp",{unique:!1}),n.createIndex("word","word",{unique:!1})}}})}async addNewRecord(e,n,r=0,a=m.LEARNING){const i={[c.WORD]:e,[c.TIMESTAMP]:Date.now(),[c.STATUS]:n,[c.UID]:r,[c.TYPE]:a};return await this.addRecord(i)}async addRecord(e){return await(await this.initDB()).add(this.storeName,e)}async getRecordsByUid(e){return await(await this.initDB()).transaction(this.storeName).store.index("uid").getAll(e)}async getRecordsByWord(e){return await(await this.initDB()).transaction(this.storeName).store.index("word").getAll(e)}async getRecordsByTimeRange(e,n){return await(await this.initDB()).transaction(this.storeName).store.index("timestamp").getAll(IDBKeyRange.bound(e,n))}async deleteRecord(e){return await(await this.initDB()).delete(this.storeName,e)}async clearAllRecords(){return await(await this.initDB()).clear(this.storeName)}async getAllRecords(){return await(await this.initDB()).getAll(this.storeName)}async updateRecord(e){return await(await this.initDB()).put(this.storeName,e)}async importRecord(e){return await this.initDB(),(await this.getRecordsByWord(e[c.WORD])).length>0?await this.updateRecord(e):await this.addRecord(e)}async generateTestData(){await this.clearAllRecords();const e=["apple","banana","orange","grape","watermelon","computer","phone","laptop","tablet","keyboard","book","pen","pencil","notebook","dictionary","student","teacher","school","university","classroom","house","building","apartment","room","kitchen"],n=new Date,r=[];for(let d=0;d<30;d++){const o=new Date(n);o.setDate(o.getDate()-d);const u=Math.floor(Math.random()*11)+5,v=e.sort(()=>Math.random()-.5).slice(0,u);for(const T of v){const E=Math.random()>.3?h.PASS:h.FAIL,D=new Date(o);if(D.setHours(Math.floor(Math.random()*12)+8),r.push({[c.WORD]:T,[c.TIMESTAMP]:D.getTime(),[c.STATUS]:E,[c.UID]:0,[c.TYPE]:m.LEARNING}),E===h.PASS){const R=new Date(D);R.setHours(R.getHours()+Math.floor(Math.random()*4)+1);const F=Math.random()>.2?h.PASS:h.FAIL;r.push({[c.WORD]:T,[c.TIMESTAMP]:R.getTime(),[c.STATUS]:F,[c.UID]:0,[c.TYPE]:m.REVIEW})}}}r.sort((d,o)=>d.timestamp-o.timestamp);const i=(await this.initDB()).transaction(this.storeName,"readwrite"),s=i.objectStore(this.storeName);for(const d of r)await s.add(d);await i.done,console.log("测试数据生成完成，共生成",r.length,"条记录")}}const C=new J;function te(t){return O({word:t,status:h.PASS,type:m.LEARNING}),console.log("addPassWordRecord",t),C.addNewRecord(t,h.PASS)}function ne(t){return O({word:t,status:h.FAIL,type:m.LEARNING}),console.log("addFailWordRecord",t),C.addNewRecord(t,h.FAIL)}export{m as W,ee as a,X as b,h as c,ne as d,te as e,Z as g,K as o,C as w};
