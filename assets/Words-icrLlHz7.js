import{n as l,d as c,s as g,e as p,a as f,f as i,m as h,h as x,S as n,i as u,j as m,k as w}from"./index-BxglavK6.js";import{k as _,S as v,D as y,C as k,W as I,a as W,o as d}from"./keyboard-ColdmY2I.js";import{W as Q,p as S,a as C}from"./wa-phonetic-audio-BtcxfDh0.js";import{f as A,p as b}from"./WordReviewDB-D_DfUb8x.js";import{g as T}from"./WordRecordDB-BZ_CPtQC.js";import{$ as N}from"./toast-pcPyfZkL.js";import"./vendor-C-Ryi81X.js";import"./utils-DttJ4vl2.js";import"./request-B2gTRJCA.js";const L={name:"Words",components:{WordsHeader:W,WordsProgress:I,WaPhoneticAudio:Q,CardActions:k,DictionaryLinks:y,SliderContainer:v},directives:{keyboard:_},data(){return{touchStartX:0,deltaX:0,isDragging:!1,isAnimating:!1,learningQueue:[],currentIdx:0,revealedSet:new Set,phonetic:"",nextRes:null}},watch:{async groupCount(){console.log("[groupCount]",this.groupCount),await this.initLearningQueue()}},computed:{curr_learning_word(){var t;return((t=this.learningQueue[this.currentIdx])==null?void 0:t.word)||""},...i("cache",["add_usr_learned_no","usr_bookId"]),...h("setting",["groupSize"]),...h("book",["wordBooks","words","currentGroup"]),...i("cache",["usr_learned_no_arr"]),...i("book",["bookName","bookId","groupCount","groupStart","groupEnd","getGroupWords","currentBookIdx"]),currWord(){return this.learningQueue[this.currentIdx]||{word:"",definition:""}},sliderWords(){let t=this.currentIdx-1;t<0&&(t=this.learningQueue.length-1);const e=this.currentIdx;let r=this.currentIdx+1;return r>=this.learningQueue.length&&(r=0),[this.learningQueue[t],this.learningQueue[e],this.learningQueue[r]]},...i("book",["progressPercent","progressText","words"]),isZhRevealed(){return this.revealedSet.has(this.curr_learning_word)&&this.curr_learning_word!==""},...i(["cacheWrapper"])},methods:{...f(["setStudyStatus"]),getWordAudioUrl:p,splitTaggedText:g,onTouchStart(t){this.isAnimating||this.learningQueue.length===0||(this.isDragging=!0,this.touchStartX=t.changedTouches[0].clientX,this.deltaX=0)},onTouchMove(t){if(!this.isDragging)return;const e=t.changedTouches[0].clientX-this.touchStartX;this.deltaX=e},async onTouchEnd(){if(!this.isDragging)return;this.isDragging=!1;const t=window.innerWidth/4;Math.abs(this.deltaX)>t&&(this.isAnimating=!0,this.deltaX>0?this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1:this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()),this.deltaX=0,await w(300),this.isAnimating=!1},async afterChange(){try{this.phonetic="";let t=this.currWord;this.phonetic=await m((t==null?void 0:t.word)||""),console.log("this.phonetic",this.phonetic),this.playCurrentWord()}catch(t){console.error("afterChange error",t)}},revealZh(){this.revealedSet.add(this.curr_learning_word),this.revealedSet=new Set(this.revealedSet)},async passWord(){if(!this.isZhRevealed){this.revealZh(),this.playCurrentWord();return}if(b(this.curr_learning_word,this.usr_bookId),this.learningQueue.length<=1){this.add_usr_learned_no(this.learningQueue[this.currentIdx]),this.nextGroupOrFinish();return}if(this.add_usr_learned_no(this.learningQueue[this.currentIdx]),this.learningQueue.splice(this.currentIdx,1),this.learningQueue.length===0){this.nextGroupOrFinish();return}this.currentIdx>=this.learningQueue.length&&(this.currentIdx=this.learningQueue.length-1),this.revealedSet.clear(),await this.afterChange()},failWord(){if(!this.isZhRevealed){this.revealZh(),this.playCurrentWord();return}A(this.curr_learning_word,this.usr_bookId),this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()},async nextGroupOrFinish(){if(this.usr_learned_no_arr.length>=this.words.length){S(),await this.openAllFinishModal();return}C(),await this.openGroupFinishModal()},async openAllFinishModal(){let t=await d({bookName:this.bookName});t.success&&(t.data?this.restartLearning():this.stopLearning())},async openGroupFinishModal(){let{currentGroup:t}=this,e=await d({bookName:`${this.bookName} - 第${t+1}组`,subtitle:"当前组已学完，是否继续下一组？",restartText:"继续下一组",homeText:"休息一下"});e.success&&(e.data?this.continueToNextGroup():this.stopAtCurrentGroup())},async restartLearning(){this.currentGroup=0,await this.initLearningQueue(),this.setStudyStatus(n.LEARNED)},async continueToNextGroup(){this.moveToNextGroup(),await this.initLearningQueue()},stopAtCurrentGroup(){this.setStudyStatus(n.LEARNED),u()},async initLearningQueue(){console.log("[this.currentBookIdx initLearningQueue]",this.usr_bookId),this.nextRes=await T({page:1,limit:this.groupSize,bid:this.usr_bookId}),this.nextRes.data.success?this.learningQueue=this.nextRes.data.data.words:(this.learningQueue=[],N.error(this.nextRes.data.message)),console.log("[this.learningQueue initLearningQueue]",this.learningQueue),this.currentIdx=0,this.revealedSet=new Set,this.deltaX=0,this.isDragging=!1,this.isAnimating=!1},...c("book",["loadBook","saveProgress","moveToNextGroup"]),async loadProgress(){await this.initLearningQueue(),await this.afterChange()},stopLearning(){this.setStudyStatus(n.LEARNED),u()},async openBookModal(){x()},async playCurrentWord(){console.log("playCurrentWord",this.$refs.phonetic),this.$refs.phonetic.playAudio()},handlePrevWord(){this.isAnimating||this.learningQueue.length===0||(this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1,this.revealedSet.clear(),this.afterChange())},handleNextWord(){this.isAnimating||this.learningQueue.length===0||(this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange())}},async mounted(){await this.loadProgress(),console.log("[this.learningQueue mounted]",this.learningQueue),this.learningQueue.length===0&&this.nextGroupOrFinish(),this.playCurrentWord()},beforeDestroy(){}};var R=function(){var e=this,r=e._self._c;return r("div",{directives:[{name:"keyboard",rawName:"v-keyboard",value:[{key:"ArrowLeft",handler:e.handlePrevWord},{key:"ArrowRight",handler:e.handleNextWord},{key:"Enter",handler:e.passWord},{key:"Escape",handler:e.failWord}],expression:`[
        { key: 'ArrowLeft', handler: handlePrevWord },
        { key: 'ArrowRight', handler: handleNextWord },
        { key: 'Enter', handler: passWord },
        { key: 'Escape', handler: failWord }
    ]`}],staticClass:"words-page",on:{touchstart:e.onTouchStart,touchmove:e.onTouchMove,touchend:e.onTouchEnd}},[r("WordsHeader",{attrs:{title:e.bookName},on:{change:e.openBookModal}}),r("WordsProgress",{directives:[{name:"show",rawName:"v-show",value:e.learningQueue.length>0,expression:"learningQueue.length > 0"}],attrs:{total:e.learningQueue.length,current:e.currentIdx+1}}),r("SliderContainer",{attrs:{items:e.sliderWords,isAnimating:e.isAnimating,deltaX:e.deltaX},scopedSlots:e._u([{key:"default",fn:function({item:s,index:X}){var a;return[s?[r("div",{staticClass:"word-en"},[e._v(e._s(s.word))]),r("div",{staticStyle:{display:"flex","flex-wrap":"nowrap","align-items":"center",gap:"16px"}},[r("WaPhoneticAudio",{ref:"phonetic",attrs:{word:(a=e.currWord)==null?void 0:a.word,phonetic:e.phonetic}})],1),r("div",{directives:[{name:"test",rawName:"v-test",value:"word-zh",expression:"'word-zh'"}],staticClass:"word-zh",class:{mosaic:!e.isZhRevealed},on:{click:e.revealZh}},e._l(e.splitTaggedText(s.definition),function(o){return r("div",{key:o,staticClass:"word-zh-item"},[e._v(" "+e._s(o)+" ")])}),0),r("DictionaryLinks",{attrs:{word:s.word}})]:e._e()]}}])}),r("CardActions",{attrs:{showIframeBtn:!1},on:{pass:e.passWord,fail:e.failWord}})],1)},G=[],D=l(L,R,G,!1,null,"169581be");const H=D.exports;export{H as default};
