import{n as b,d as N,s as F,e as G,a as y,f as g,m as S,h as L,S as m,i as k,j as P,k as X}from"./index-Bwr9syQ3.js";import{k as B,S as $,D as z,C as Z,W as O,a as U,o as W}from"./keyboard-9Wdx0sK3.js";import{W as H,a as Y}from"./wa-phonetic-audio-B5tixSIy.js";import{w as v,f as j,p as K}from"./WordReviewDB-DBCaidFV.js";import{r as f,o as C,c as V,w as q,b as J,g as ee}from"./vendor-C-Ryi81X.js";import{$ as te}from"./toast-DkpKqXYP.js";import{a as re}from"./WordRecordDB-DApXd7If.js";import"./utils-DttJ4vl2.js";import"./request-DLDTzHiv.js";const ae={__name:"Sm2TestPanel",setup(r){const e=f(!1),t=f([]),s=f(""),a=f([]),o=f([]);function l(i){const n=new Date;return n.setDate(n.getDate()+i),n.toISOString().slice(0,10)}a.value=Array.from({length:31},(i,n)=>l(n-15)),s.value=l(0);async function u(){const i=await v.getAllWords();o.value=i.filter(n=>{if(!n.next_review)return!1;const d=new Date(n.next_review);return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")===s.value})}C(()=>{u()});const p=ee();let x=V(()=>{var i,n;return(((n=(i=p==null?void 0:p.proxy)==null?void 0:i.$parent)==null?void 0:n.words)||[]).map(d=>d.en)});async function D(){let n=x.value;if(!n||n.length===0){alert("No words in current wordbook!");return}let d=[],_=new Set;for(;d.length<20&&_.size<n.length;){let h=Math.floor(Math.random()*n.length);_.has(h)||(d.push(n[h]),_.add(h))}for(let h of d){const M=+(1.3+Math.random()*1.2).toFixed(2),Q=Math.floor(Math.random()*31),T=Math.floor(Math.random()*11),E=Math.floor(Math.random()*31)-15,R=Date.now()+E*864e5;await v.addWord(h);let c=await v.getWord(h);c.EF=M,c.interval=Q,c.repetitions=T,c.next_review=R,await v.putWord(c)}alert("Mock data generated!"),u()}async function I(){t.value=await v.getAllWords(),e.value=!0}function A(i){return i?new Date(i).toLocaleString():"-"}q(e,i=>{i?document.body.style.overflow="hidden":document.body.style.overflow=""});function w(i){e.value&&(i.key==="Escape"||i.key==="Esc")&&(e.value=!1)}return C(()=>{window.addEventListener("keydown",w)}),J(()=>{window.removeEventListener("keydown",w),document.body.style.overflow=""}),{__sfc:!0,showModal:e,allWords:t,selectedDate:s,dateOptions:a,filteredWords:o,getDateStr:l,handleDateChange:u,instance:p,wordsList:x,handleGenerateMockData:D,handleShowAllData:I,formatDate:A,handleKeydown:w}}};var se=function(){var e=this,t=e._self._c,s=e._self._setupProxy;return t("div",{staticClass:"sm2-test-panel"},[t("span",{staticClass:"desc"},[e._v("For SM2/DB testing only")]),t("div",{staticClass:"date-select-wrap"},[t("label",{attrs:{for:"date-select"}},[e._v("Select review date:")]),t("select",{directives:[{name:"model",rawName:"v-model",value:s.selectedDate,expression:"selectedDate"}],attrs:{id:"date-select"},on:{change:[function(a){var o=Array.prototype.filter.call(a.target.options,function(l){return l.selected}).map(function(l){var u="_value"in l?l._value:l.value;return u});s.selectedDate=a.target.multiple?o:o[0]},s.handleDateChange]}},e._l(s.dateOptions,function(a){return t("option",{key:a,domProps:{value:a}},[e._v(e._s(a))])}),0)]),s.filteredWords.length?t("div",{staticClass:"table-wrap"},[t("table",{staticClass:"db-table"},[e._m(0),t("tbody",e._l(s.filteredWords,function(a,o){return t("tr",{key:a.word,class:{odd:o%2===1}},[t("td",[e._v(e._s(a.word))]),t("td",[e._v(e._s(a.EF.toFixed(2)))]),t("td",[e._v(e._s(a.interval))]),t("td",[e._v(e._s(a.repetitions))]),t("td",[e._v(e._s(s.formatDate(a.next_review)||"-"))])])}),0)])]):e._e(),s.showModal?t("div",{staticClass:"modal-mask",on:{click:function(a){if(a.target!==a.currentTarget)return null;s.showModal=!1}}},[t("div",{staticClass:"modal-box"},[t("button",{staticClass:"close-btn",attrs:{"aria-label":"Close"},on:{click:function(a){s.showModal=!1}}},[e._v("×")]),t("div",{staticClass:"modal-title"},[e._v("All Words in DB")]),t("div",{staticClass:"table-wrap"},[t("table",{staticClass:"db-table"},[e._m(1),t("tbody",e._l(s.allWords,function(a,o){return t("tr",{key:a.word,class:{odd:o%2===1}},[t("td",[e._v(e._s(a.word))]),t("td",[e._v(e._s(a.EF.toFixed(2)))]),t("td",[e._v(e._s(a.interval))]),t("td",[e._v(e._s(a.repetitions))]),t("td",[e._v(e._s(s.formatDate(a.next_review)||"-"))])])}),0)])])])]):e._e(),t("button",{staticClass:"main-btn",on:{click:s.handleGenerateMockData}},[t("span",{staticClass:"icon"},[e._v("+")]),e._v(" Generate Mock Data ")]),t("button",{staticClass:"main-btn green",on:{click:s.handleShowAllData}},[t("span",{staticClass:"icon"},[e._v("≡")]),e._v(" Show All Words (DB) ")])])},ne=[function(){var r=this,e=r._self._c;return r._self._setupProxy,e("thead",[e("tr",[e("th",[r._v("Word")]),e("th",[r._v("EF")]),e("th",[r._v("Interval")]),e("th",[r._v("Repetitions")]),e("th",[r._v("Next Review")])])])},function(){var r=this,e=r._self._c;return r._self._setupProxy,e("thead",[e("tr",[e("th",[r._v("Word")]),e("th",[r._v("EF")]),e("th",[r._v("Interval")]),e("th",[r._v("Repetitions")]),e("th",[r._v("Next Review")])])])}],ie=b(ae,se,ne,!1,null,"3939abc3");const oe=ie.exports,le={name:"ReviewWords",components:{WordsHeader:U,WordsProgress:O,WaPhoneticAudio:H,CardActions:Z,DictionaryLinks:z,SliderContainer:$,Sm2TestPanel:oe},directives:{keyboard:B},data(){return{touchStartX:0,deltaX:0,isDragging:!1,isAnimating:!1,learningQueue:[],learningQueue_cache:[],currentIdx:0,revealedSet:new Set,phonetic:"",nextRes:null}},watch:{currentIdx(){}},computed:{curr_learning_word(){var r;return(r=this.learningQueue[this.currentIdx])==null?void 0:r.word},...g("cache",["add_usr_learned_no"]),...S("setting",["groupSize"]),...S("book",["wordBooks","words","currentGroup"]),...g("cache",["usr_learned_no_arr"]),...g("book",["bookName","bookId","groupCount","groupStart","groupEnd","getRvGroupWords","currentBookIdx"]),currWord(){return this.learningQueue[this.currentIdx]||{word:"",definition:""}},sliderWords(){let r=this.currentIdx-1;r<0&&(r=this.learningQueue.length-1);const e=this.currentIdx;let t=this.currentIdx+1;return t>=this.learningQueue.length&&(t=0),[this.learningQueue[r],this.learningQueue[e],this.learningQueue[t]]},...g("book",["progressPercent","progressText","words"]),isZhRevealed(){return this.revealedSet.has(this.curr_learning_word)},...g(["cacheWrapper","isDebugMode"])},methods:{...y("book",["setCurrentBookIdx"]),...y(["setStudyStatus"]),getWordAudioUrl:G,splitTaggedText:F,onTouchStart(r){this.isAnimating||this.learningQueue.length===0||(this.isDragging=!0,this.touchStartX=r.changedTouches[0].clientX,this.deltaX=0)},onTouchMove(r){if(!this.isDragging)return;const e=r.changedTouches[0].clientX-this.touchStartX;this.deltaX=e},async onTouchEnd(){if(!this.isDragging)return;this.isDragging=!1;const r=window.innerWidth/4;Math.abs(this.deltaX)>r&&(this.isAnimating=!0,this.deltaX>0?this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1:this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()),this.deltaX=0,await X(300),this.isAnimating=!1},async afterChange(){try{this.phonetic="";let r=this.currWord;this.phonetic=await P((r==null?void 0:r.word)||""),console.log("this.phonetic",this.phonetic),this.playCurrentWord()}catch(r){console.error("afterChange error",r)}},revealZh(){this.revealedSet.add(this.curr_learning_word),this.revealedSet=new Set(this.revealedSet)},async passWord(){if(!this.isZhRevealed){this.revealZh(),this.playCurrentWord();return}if(K(this.curr_learning_word),this.learningQueue.length<=1){this.nextGroupOrFinish();return}if(this.learningQueue.splice(this.currentIdx,1),this.learningQueue.length===0){this.nextGroupOrFinish();return}this.currentIdx>=this.learningQueue.length&&(this.currentIdx=this.learningQueue.length-1),this.revealedSet.clear(),await this.afterChange()},failWord(){if(!this.isZhRevealed){this.revealZh(),this.playCurrentWord();return}j(this.curr_learning_word),this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()},async nextGroupOrFinish(){Y(),await this.openGroupFinishModal()},async openAllFinishModal(){let r=await W({bookName:this.bookName,subtitle:"复习结束啦",restartText:"再来一次",homeText:"休息一下"});r.success&&(r.data?this.restartLearning():this.stopLearning())},async openGroupFinishModal(){let{currentGroup:r}=this,e=await W({bookName:`${this.bookName} - 第${r+1}组`,subtitle:"当前组已学完，是否继续下一组？",restartText:"继续下一组",homeText:"休息一下"});e.success&&(e.data?this.continueToNextGroup():this.stopAtCurrentGroup())},async restartLearning(){this.currentGroup=0,await this.initLearningQueue(),this.setStudyStatus(m.LEARNED)},async continueToNextGroup(){this.moveToNextGroup(),await this.initLearningQueue()},stopAtCurrentGroup(){this.setStudyStatus(m.LEARNED),k()},async initLearningQueue(){let r=await re({page:1,limit:this.groupSize,dictIndex:Math.max(this.currentBookIdx,0)||0});r.data.success?this.learningQueue=r.data.data.words:te.error(r.data.message),this.currentIdx=0,this.revealedSet=new Set,this.deltaX=0,this.isDragging=!1,this.isAnimating=!1},...N("book",["loadBook","saveProgress","moveToNextGroup"]),async loadProgress(){await this.initLearningQueue(),await this.afterChange()},stopLearning(){this.setStudyStatus(m.LEARNED),k()},async openBookModal(){L()},async playCurrentWord(){console.log("playCurrentWord",this.$refs.phonetic),this.$refs.phonetic.playAudio()},handlePrevWord(){this.isAnimating||this.learningQueue.length===0||(this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1,this.revealedSet.clear(),this.afterChange())},handleNextWord(){this.isAnimating||this.learningQueue.length===0||(this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange())}},async mounted(){await this.loadProgress(),this.learningQueue.length===0&&this.openAllFinishModal()},beforeDestroy(){}};var de=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"keyboard",rawName:"v-keyboard",value:[{key:"ArrowLeft",handler:e.handlePrevWord},{key:"ArrowRight",handler:e.handleNextWord},{key:"Enter",handler:e.passWord},{key:"Escape",handler:e.failWord}],expression:`[
        { key: 'ArrowLeft', handler: handlePrevWord },
        { key: 'ArrowRight', handler: handleNextWord },
        { key: 'Enter', handler: passWord },
        { key: 'Escape', handler: failWord }
    ]`}],staticClass:"words-page",on:{touchstart:e.onTouchStart,touchmove:e.onTouchMove,touchend:e.onTouchEnd}},[t("WordsHeader",{attrs:{title:e.bookName},on:{change:e.openBookModal}}),t("WordsProgress",{directives:[{name:"show",rawName:"v-show",value:e.learningQueue.length>0,expression:"learningQueue.length > 0"}],attrs:{total:e.learningQueue.length,current:e.currentIdx+1}}),t("SliderContainer",{attrs:{items:e.sliderWords,isAnimating:e.isAnimating,deltaX:e.deltaX},scopedSlots:e._u([{key:"default",fn:function({item:s,index:a}){var o;return[t("div",{staticClass:"word-en"},[e._v(e._s(s.word))]),t("div",{staticStyle:{display:"flex","flex-wrap":"nowrap","align-items":"center",gap:"16px"}},[t("WaPhoneticAudio",{ref:"phonetic",attrs:{word:(o=e.currWord)==null?void 0:o.word,phonetic:e.phonetic}})],1),t("div",{directives:[{name:"test",rawName:"v-test",value:"word-zh",expression:"'word-zh'"}],staticClass:"word-zh",class:{mosaic:!e.isZhRevealed},on:{click:e.revealZh}},e._l(e.splitTaggedText(s.definition),function(l){return t("div",{key:l,staticClass:"word-zh-item"},[e._v(" "+e._s(l)+" ")])}),0),t("DictionaryLinks",{attrs:{word:s.word}})]}}])}),t("CardActions",{attrs:{showIframeBtn:!1},on:{pass:e.passWord,fail:e.failWord}}),e.isDebugMode?t("Sm2TestPanel"):e._e()],1)},he=[],ue=b(le,de,he,!1,null,"2d1755d2");const ye=ue.exports;export{ye as default};
