import{n as y,I as F,l as E,d as G,s as N,e as R,a as S,f as _,m as B,h as $,S as m,i as k,j as X,k as O}from"./index-BqJ9MkEI.js";import{S as z,D as U,C as Z,W as j,a as H,o as b}from"./SliderContainer-D1dUVSNb.js";import{$ as C}from"./toast-CEWDI-I-.js";import{w as c,f as Y,p as q}from"./WordReviewDB-Dwf42sz8.js";import{a as J,b as K}from"./audio-R9zsCmt4.js";import{r as f,o as D,c as V,w as ee,b as te,g as se}from"./vendor-C-Ryi81X.js";import"./utils-DttJ4vl2.js";import"./WordRecordDB-ZKtcZKYU.js";const ae={name:"AudioButton",components:{Icon:F},props:{word:{type:String,required:!0},title:{type:String,default:"播放发音"}},data(){return{isPlaying:!1,isLoading:!1,audioPlayer:null}},methods:{play(){this.handleClick()},async handleClick(){if(console.log("jser click"),!!this.word){this.audioPlayer&&this.audioPlayer.pause(),this.isLoading=!0;try{let s=await E(this.word);if(!s){C.error("网络异常，请稍后重试");return}this.audioPlayer=new Audio(s),this.audioPlayer.addEventListener("ended",()=>{this.isPlaying=!1}),await this.audioPlayer.play(),this.isPlaying=!0}catch(s){console.error("Failed to play audio:",s),this.isPlaying=!1,C.error("播放失败，请稍后重试")}finally{this.isLoading=!1}}}},beforeDestroy(){this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer.src="",this.audioPlayer=null),this.isPlaying=!1,this.isLoading=!1}};var re=function(){var e=this,t=e._self._c;return t("div",{staticClass:"audio-btn",class:{"is-playing":e.isPlaying,"is-loading":e.isLoading},attrs:{title:e.title},on:{click:e.handleClick}},[e.isLoading?t("Icon",{staticClass:"loading-icon",style:{color:"#3578e5"},attrs:{icon:"mdi:loading",width:"32",height:"32"}}):t("Icon",{style:{color:"#3578e5"},attrs:{icon:"mdi:volume-high",width:"32",height:"32"}})],1)},ne=[],ie=y(ae,re,ne,!1,null,"727b9fb6");const oe=ie.exports;function le(s,e){try{return JSON.parse(sessionStorage.getItem(s))||e}catch{return e}}const de={__name:"Sm2TestPanel",setup(s){const e=f(!1),t=f([]),r=f(""),a=f([]),o=f([]);function l(i){const n=new Date;return n.setDate(n.getDate()+i),n.toISOString().slice(0,10)}a.value=Array.from({length:31},(i,n)=>l(n-15)),r.value=l(0);async function h(){const i=await c.getAllWords();o.value=i.filter(n=>{if(!n.next_review)return!1;const d=new Date(n.next_review);return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")===r.value})}D(()=>{h()});const v=se();let x=V(()=>{var i,n;return(((n=(i=v==null?void 0:v.proxy)==null?void 0:i.$parent)==null?void 0:n.words)||[]).map(d=>d.en)});async function W(){let n=x.value;if(!n||n.length===0){alert("No words in current wordbook!");return}let d=[],p=new Set;for(;d.length<20&&p.size<n.length;){let u=Math.floor(Math.random()*n.length);p.has(u)||(d.push(n[u]),p.add(u))}for(let u of d){const M=+(1.3+Math.random()*1.2).toFixed(2),Q=Math.floor(Math.random()*31),P=Math.floor(Math.random()*11),T=Math.floor(Math.random()*31)-15,L=Date.now()+T*864e5;await c.addWord(u);let g=await c.getWord(u);g.EF=M,g.interval=Q,g.repetitions=P,g.next_review=L,await c.putWord(g)}alert("Mock data generated!"),h()}async function I(){t.value=await c.getAllWords(),e.value=!0}function A(i){return i?new Date(i).toLocaleString():"-"}ee(e,i=>{i?document.body.style.overflow="hidden":document.body.style.overflow=""});function w(i){e.value&&(i.key==="Escape"||i.key==="Esc")&&(e.value=!1)}return D(()=>{window.addEventListener("keydown",w)}),te(()=>{window.removeEventListener("keydown",w),document.body.style.overflow=""}),{__sfc:!0,showModal:e,allWords:t,selectedDate:r,dateOptions:a,filteredWords:o,getDateStr:l,handleDateChange:h,instance:v,wordsList:x,handleGenerateMockData:W,handleShowAllData:I,formatDate:A,handleKeydown:w}}};var ue=function(){var e=this,t=e._self._c,r=e._self._setupProxy;return t("div",{staticClass:"sm2-test-panel"},[t("span",{staticClass:"desc"},[e._v("For SM2/DB testing only")]),t("div",{staticClass:"date-select-wrap"},[t("label",{attrs:{for:"date-select"}},[e._v("Select review date:")]),t("select",{directives:[{name:"model",rawName:"v-model",value:r.selectedDate,expression:"selectedDate"}],attrs:{id:"date-select"},on:{change:[function(a){var o=Array.prototype.filter.call(a.target.options,function(l){return l.selected}).map(function(l){var h="_value"in l?l._value:l.value;return h});r.selectedDate=a.target.multiple?o:o[0]},r.handleDateChange]}},e._l(r.dateOptions,function(a){return t("option",{key:a,domProps:{value:a}},[e._v(e._s(a))])}),0)]),r.filteredWords.length?t("div",{staticClass:"table-wrap"},[t("table",{staticClass:"db-table"},[e._m(0),t("tbody",e._l(r.filteredWords,function(a,o){return t("tr",{key:a.word,class:{odd:o%2===1}},[t("td",[e._v(e._s(a.word))]),t("td",[e._v(e._s(a.EF.toFixed(2)))]),t("td",[e._v(e._s(a.interval))]),t("td",[e._v(e._s(a.repetitions))]),t("td",[e._v(e._s(r.formatDate(a.next_review)||"-"))])])}),0)])]):e._e(),r.showModal?t("div",{staticClass:"modal-mask",on:{click:function(a){if(a.target!==a.currentTarget)return null;r.showModal=!1}}},[t("div",{staticClass:"modal-box"},[t("button",{staticClass:"close-btn",attrs:{"aria-label":"Close"},on:{click:function(a){r.showModal=!1}}},[e._v("×")]),t("div",{staticClass:"modal-title"},[e._v("All Words in DB")]),t("div",{staticClass:"table-wrap"},[t("table",{staticClass:"db-table"},[e._m(1),t("tbody",e._l(r.allWords,function(a,o){return t("tr",{key:a.word,class:{odd:o%2===1}},[t("td",[e._v(e._s(a.word))]),t("td",[e._v(e._s(a.EF.toFixed(2)))]),t("td",[e._v(e._s(a.interval))]),t("td",[e._v(e._s(a.repetitions))]),t("td",[e._v(e._s(r.formatDate(a.next_review)||"-"))])])}),0)])])])]):e._e(),t("button",{staticClass:"main-btn",on:{click:r.handleGenerateMockData}},[t("span",{staticClass:"icon"},[e._v("+")]),e._v(" Generate Mock Data ")]),t("button",{staticClass:"main-btn green",on:{click:r.handleShowAllData}},[t("span",{staticClass:"icon"},[e._v("≡")]),e._v(" Show All Words (DB) ")])])},ce=[function(){var s=this,e=s._self._c;return s._self._setupProxy,e("thead",[e("tr",[e("th",[s._v("Word")]),e("th",[s._v("EF")]),e("th",[s._v("Interval")]),e("th",[s._v("Repetitions")]),e("th",[s._v("Next Review")])])])},function(){var s=this,e=s._self._c;return s._self._setupProxy,e("thead",[e("tr",[e("th",[s._v("Word")]),e("th",[s._v("EF")]),e("th",[s._v("Interval")]),e("th",[s._v("Repetitions")]),e("th",[s._v("Next Review")])])])}],he=y(de,ue,ce,!1,null,"3939abc3");const ge=he.exports,_e="rv_word_cache";function fe(s){return le(_e,{})[s]||[]}const ve={name:"Words",components:{WordsHeader:H,WordsProgress:j,AudioButton:oe,CardActions:Z,DictionaryLinks:U,SliderContainer:z,Sm2TestPanel:ge},data(){return{touchStartX:0,deltaX:0,isDragging:!1,isAnimating:!1,learningQueue:[],learningQueue_cache:[],currentIdx:0,revealedSet:new Set,phonetic:"",clicked:!1}},watch:{currentIdx(){}},computed:{curr_learning_word(){let s=this.learningQueue[this.currentIdx];return this.words[s].en},..._("cache",["add_usr_learned_no"]),...B("book",["currentBookIdx","wordBooks","words","GROUP_SIZE","currentGroup"]),..._("cache",["usr_learned_no_arr"]),..._("book",["bookName","bookId","groupCount","groupStart","groupEnd","getRvGroupWords"]),currWord(){return this.sliderWords[1]},sliderWords(){const s=this.learningQueue[this.currentIdx-1],e=this.learningQueue[this.currentIdx],t=this.learningQueue[this.currentIdx+1],r=o=>typeof o=="number"?this.words[o]||{en:"",zh:"",enDef:""}:{en:"",zh:"",enDef:""};let a=[r(s),r(e),r(t)];return console.log("[sld_words]",a,s,e,t,this.learningQueue),a},..._("book",["progressPercent","progressText","words"]),isZhRevealed(){return this.revealedSet.has(this.learningQueue[this.currentIdx])},..._(["cacheWrapper","isDebugMode"])},methods:{...S("book",["setCurrentBookIdx"]),...S(["setStudyStatus"]),getWordAudioUrl:R,splitTaggedText:N,onTouchStart(s){this.isAnimating||this.learningQueue.length===0||(this.isDragging=!0,this.touchStartX=s.changedTouches[0].clientX,this.deltaX=0)},onTouchMove(s){if(!this.isDragging)return;const e=s.changedTouches[0].clientX-this.touchStartX;this.deltaX=e},async onTouchEnd(){if(!this.isDragging)return;this.isDragging=!1;const s=window.innerWidth/4;Math.abs(this.deltaX)>s&&(this.isAnimating=!0,this.deltaX>0?this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1:this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()),this.deltaX=0,await O(300),this.isAnimating=!1},async afterChange(){let s=this.currWord;this.phonetic=await X((s==null?void 0:s.en)||""),this.playCurrentWord()},revealZh(){this.revealedSet.add(this.learningQueue[this.currentIdx]),this.revealedSet=new Set(this.revealedSet)},passWord(){if(q(this.curr_learning_word),this.learningQueue.length<=1){this.nextGroupOrFinish();return}if(this.learningQueue.splice(this.currentIdx,1),this.learningQueue.length===0){this.nextGroupOrFinish();return}this.currentIdx>=this.learningQueue.length&&(this.currentIdx=this.learningQueue.length-1),this.revealedSet.clear(),this.afterChange()},failWord(){Y(this.curr_learning_word),this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,K(),this.revealedSet.clear()},async nextGroupOrFinish(){J(),await this.openGroupFinishModal()},async openAllFinishModal(){let s=await b({bookName:this.bookName,subtitle:"复习结束啦",restartText:"再来一次",homeText:"休息一下"});s.success&&(s.data?this.restartLearning():this.stopLearning())},async openGroupFinishModal(){let{currentGroup:s}=this,e=await b({bookName:`${this.bookName} - 第${s+1}组`,subtitle:"当前组已学完，是否继续下一组？",restartText:"继续下一组",homeText:"休息一下"});e.success&&(e.data?this.continueToNextGroup():this.stopAtCurrentGroup())},async restartLearning(){this.currentGroup=0,await this.initLearningQueue(),this.setStudyStatus(m.LEARNED)},async continueToNextGroup(){this.moveToNextGroup(),await this.initLearningQueue()},stopAtCurrentGroup(){this.setStudyStatus(m.LEARNED),k()},async initLearningQueue(){let e=(await c.getTodayWords()).map(t=>this.words.findIndex(r=>r.en===t.word)).filter(t=>t!==-1);this.learningQueue=e,console.log("[this.learningQueue initLearningQueue]",this.learningQueue),this.currentIdx=0,this.revealedSet=new Set,this.deltaX=0,this.isDragging=!1,this.isAnimating=!1},...G("book",["loadBook","saveProgress","moveToNextGroup"]),async loadProgress(){await this.initLearningQueue(),this.afterChange()},stopLearning(){this.setStudyStatus(m.LEARNED),k()},async openBookModal(){$()},async playCurrentWord(){this.clicked&&this.$refs.audioButton.play()}},async mounted(){await this.loadProgress(),this.learningQueue_cache=fe(this.bookId),this.learningQueue=this.learningQueue.filter(s=>!this.learningQueue_cache.includes(s)),this.learningQueue.length===0&&this.openAllFinishModal()},beforeDestroy(){}};var pe=function(){var e=this,t=e._self._c;return t("div",{staticClass:"words-page",on:{click:function(r){e.clicked=!0},touchstart:e.onTouchStart,touchmove:e.onTouchMove,touchend:e.onTouchEnd}},[t("WordsHeader",{attrs:{title:e.bookName},on:{change:e.openBookModal}}),t("WordsProgress",{directives:[{name:"show",rawName:"v-show",value:e.learningQueue.length>0,expression:"learningQueue.length > 0"}],attrs:{total:e.learningQueue.length,current:e.currentIdx+1}}),t("SliderContainer",{attrs:{items:e.sliderWords,isAnimating:e.isAnimating,deltaX:e.deltaX},scopedSlots:e._u([{key:"default",fn:function({item:r}){var a;return[t("div",{staticClass:"word-en"},[e._v(e._s(r.en))]),t("div",{staticStyle:{display:"flex","flex-wrap":"nowrap","align-items":"center",gap:"16px"}},[t("div",{staticClass:"phonetic-text",staticStyle:{"min-width":"100px",cursor:"pointer",color:"#666","font-family":"'IPA', monospace"},on:{click:e.playCurrentWord}},[e._v(" "+e._s(e.phonetic)+" ")]),t("AudioButton",{ref:"audioButton",attrs:{word:(a=e.currWord)==null?void 0:a.en,title:"播放发音"}})],1),t("div",{staticClass:"word-zh",class:{mosaic:!e.isZhRevealed},on:{click:e.revealZh}},e._l(e.splitTaggedText(r.zh),function(o){return t("div",{key:o,staticClass:"word-zh-item"},[e._v(" "+e._s(o)+" ")])}),0),t("DictionaryLinks",{attrs:{word:r.en}})]}}])}),t("CardActions",{on:{pass:e.passWord,fail:e.failWord}}),e.isDebugMode?t("Sm2TestPanel"):e._e()],1)},we=[],me=y(ve,pe,we,!1,null,"3ab44ab3");const Ie=me.exports;export{Ie as default};
