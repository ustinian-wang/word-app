import{n as p,d as f,s as m,e as x,a as v,f as o,m as y,h as w,S as h,i as l,j as _,k}from"./index-BAodwoWl.js";import{S as W,D as S,C as I,W as Q,a as C,o as c}from"./SliderContainer-DnTFXR_x.js";import{W as A}from"./wa-phonetic-audio-CZ5kN67k.js";import{f as b,p as T}from"./WordReviewDB-Dwf42sz8.js";import{p as D,a as G}from"./audio-R9zsCmt4.js";import"./vendor-C-Ryi81X.js";import"./utils-DttJ4vl2.js";import"./WordRecordDB-ZKtcZKYU.js";const L={bind(t,e,r){const n=r.context,{value:i}=e,s=a=>{if(!i)return;const g=Array.isArray(i)?i:[i];for(const{key:u,handler:d}of g)if(u&&d&&a.key===u){a.preventDefault(),d.call(n);break}};t._keyboardHandler=s,window.addEventListener("keydown",s)},unbind(t){window.removeEventListener("keydown",t._keyboardHandler),delete t._keyboardHandler}},N={name:"Words",components:{WordsHeader:C,WordsProgress:Q,WaPhoneticAudio:A,CardActions:I,DictionaryLinks:S,SliderContainer:W},directives:{keyboard:L},data(){return{touchStartX:0,deltaX:0,isDragging:!1,isAnimating:!1,learningQueue:[],currentIdx:0,revealedSet:new Set,phonetic:""}},watch:{groupCount(){console.log("[groupCount]",this.groupCount),this.initLearningQueue()}},computed:{curr_learning_word(){let t=this.learningQueue[this.currentIdx];return this.words[t].en},...o("cache",["add_usr_learned_no"]),...y("book",["currentBookIdx","wordBooks","words","GROUP_SIZE","currentGroup"]),...o("cache",["usr_learned_no_arr"]),...o("book",["bookName","bookId","groupCount","groupStart","groupEnd","getGroupWords"]),currWord(){return this.sliderWords[1]},sliderWords(){const t=this.learningQueue[this.currentIdx-1],e=this.learningQueue[this.currentIdx],r=this.learningQueue[this.currentIdx+1],n=i=>typeof i=="number"?this.words[i]||{en:"",zh:"",enDef:""}:{en:"",zh:"",enDef:""};return[n(t),n(e),n(r)]},...o("book",["progressPercent","progressText","words"]),isZhRevealed(){return this.revealedSet.has(this.learningQueue[this.currentIdx])},...o(["cacheWrapper"])},methods:{...v(["setStudyStatus"]),getWordAudioUrl:x,splitTaggedText:m,onTouchStart(t){this.isAnimating||this.learningQueue.length===0||(this.isDragging=!0,this.touchStartX=t.changedTouches[0].clientX,this.deltaX=0)},onTouchMove(t){if(!this.isDragging)return;const e=t.changedTouches[0].clientX-this.touchStartX;this.deltaX=e},async onTouchEnd(){if(!this.isDragging)return;this.isDragging=!1;const t=window.innerWidth/4;Math.abs(this.deltaX)>t&&(this.isAnimating=!0,this.deltaX>0?this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1:this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()),this.deltaX=0,await k(300),this.isAnimating=!1},async afterChange(){try{this.phonetic="";let t=this.currWord;this.phonetic=await _((t==null?void 0:t.en)||""),console.log("this.phonetic",this.phonetic),this.playCurrentWord()}catch(t){console.error("afterChange error",t)}},revealZh(){this.revealedSet.add(this.learningQueue[this.currentIdx]),this.revealedSet=new Set(this.revealedSet)},async passWord(){if(!this.isZhRevealed){this.revealZh(),this.playCurrentWord();return}if(T(this.curr_learning_word),this.learningQueue.length<=1){this.add_usr_learned_no(this.learningQueue[this.currentIdx]),this.nextGroupOrFinish();return}if(this.add_usr_learned_no(this.learningQueue[this.currentIdx]),this.learningQueue.splice(this.currentIdx,1),this.learningQueue.length===0){this.nextGroupOrFinish();return}this.currentIdx>=this.learningQueue.length&&(this.currentIdx=this.learningQueue.length-1),this.revealedSet.clear(),await this.afterChange()},failWord(){if(!this.isZhRevealed){this.revealZh(),this.playCurrentWord();return}b(this.curr_learning_word),this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange()},async nextGroupOrFinish(){if(this.usr_learned_no_arr.length>=this.words.length){D(),await this.openAllFinishModal();return}G(),await this.openGroupFinishModal()},async openAllFinishModal(){let t=await c({bookName:this.bookName});t.success&&(t.data?this.restartLearning():this.stopLearning())},async openGroupFinishModal(){let{currentGroup:t}=this,e=await c({bookName:`${this.bookName} - 第${t+1}组`,subtitle:"当前组已学完，是否继续下一组？",restartText:"继续下一组",homeText:"休息一下"});e.success&&(e.data?this.continueToNextGroup():this.stopAtCurrentGroup())},restartLearning(){this.currentGroup=0,this.initLearningQueue(),this.setStudyStatus(h.LEARNED)},continueToNextGroup(){this.moveToNextGroup(),this.initLearningQueue()},stopAtCurrentGroup(){this.setStudyStatus(h.LEARNED),l()},initLearningQueue(){this.learningQueue=this.getGroupWords(),console.log("[this.learningQueue initLearningQueue]",this.learningQueue),this.currentIdx=0,this.revealedSet=new Set,this.deltaX=0,this.isDragging=!1,this.isAnimating=!1},...f("book",["loadBook","saveProgress","moveToNextGroup"]),loadProgress(){this.initLearningQueue(),this.afterChange()},stopLearning(){this.setStudyStatus(h.LEARNED),l()},async openBookModal(){w()},async playCurrentWord(){console.log("playCurrentWord",this.$refs.phonetic),this.$refs.phonetic.playAudio()},handlePrevWord(){this.isAnimating||this.learningQueue.length===0||(this.currentIdx>0?this.currentIdx--:this.currentIdx=this.learningQueue.length-1,this.revealedSet.clear(),this.afterChange())},handleNextWord(){this.isAnimating||this.learningQueue.length===0||(this.currentIdx<this.learningQueue.length-1?this.currentIdx++:this.currentIdx=0,this.revealedSet.clear(),this.afterChange())}},mounted(){this.loadProgress(),console.log("[this.learningQueue mounted]",this.learningQueue),this.learningQueue.length===0&&this.nextGroupOrFinish(),this.playCurrentWord()},beforeDestroy(){}};var E=function(){var e=this,r=e._self._c;return r("div",{directives:[{name:"keyboard",rawName:"v-keyboard",value:[{key:"ArrowLeft",handler:e.handlePrevWord},{key:"ArrowRight",handler:e.handleNextWord},{key:"Enter",handler:e.passWord},{key:"Escape",handler:e.failWord}],expression:`[
        { key: 'ArrowLeft', handler: handlePrevWord },
        { key: 'ArrowRight', handler: handleNextWord },
        { key: 'Enter', handler: passWord },
        { key: 'Escape', handler: failWord }
    ]`}],staticClass:"words-page",on:{touchstart:e.onTouchStart,touchmove:e.onTouchMove,touchend:e.onTouchEnd}},[r("WordsHeader",{attrs:{title:e.bookName},on:{change:e.openBookModal}}),r("WordsProgress",{directives:[{name:"show",rawName:"v-show",value:e.learningQueue.length>0,expression:"learningQueue.length > 0"}],attrs:{total:e.learningQueue.length,current:e.currentIdx+1}}),r("SliderContainer",{attrs:{items:e.sliderWords,isAnimating:e.isAnimating,deltaX:e.deltaX},scopedSlots:e._u([{key:"default",fn:function({item:n,index:i}){var s;return[r("div",{staticClass:"word-en"},[e._v(e._s(n.en))]),r("div",{staticStyle:{display:"flex","flex-wrap":"nowrap","align-items":"center",gap:"16px"}},[r("WaPhoneticAudio",{ref:"phonetic",attrs:{word:(s=e.currWord)==null?void 0:s.en,phonetic:e.phonetic}})],1),r("div",{directives:[{name:"test",rawName:"v-test",value:"word-zh",expression:"'word-zh'"}],staticClass:"word-zh",class:{mosaic:!e.isZhRevealed},on:{click:e.revealZh}},e._l(e.splitTaggedText(n.zh),function(a){return r("div",{key:a,staticClass:"word-zh-item"},[e._v(" "+e._s(a)+" ")])}),0),r("DictionaryLinks",{attrs:{word:n.en}})]}}])}),r("CardActions",{attrs:{showIframeBtn:!1},on:{pass:e.passWord,fail:e.failWord}})],1)},X=[],R=p(N,E,X,!1,null,"ffd23f3c");const U=R.exports;export{U as default};
