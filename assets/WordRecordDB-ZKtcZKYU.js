const R=(t,e)=>e.some(n=>t instanceof n);let A,p;function F(){return A||(A=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function v(){return p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const b=new WeakMap,D=new WeakMap,m=new WeakMap;function j(t){const e=new Promise((n,r)=>{const a=()=>{t.removeEventListener("success",i),t.removeEventListener("error",s)},i=()=>{n(l(t.result)),a()},s=()=>{r(t.error),a()};t.addEventListener("success",i),t.addEventListener("error",s)});return m.set(e,t),e}function U(t){if(b.has(t))return;const e=new Promise((n,r)=>{const a=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",s),t.removeEventListener("abort",s)},i=()=>{n(),a()},s=()=>{r(t.error||new DOMException("AbortError","AbortError")),a()};t.addEventListener("complete",i),t.addEventListener("error",s),t.addEventListener("abort",s)});b.set(t,e)}let B={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return b.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return l(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function W(t){B=t(B)}function V(t){return v().includes(t)?function(...e){return t.apply(g(this),e),l(this.request)}:function(...e){return l(t.apply(g(this),e))}}function k(t){return typeof t=="function"?V(t):(t instanceof IDBTransaction&&U(t),R(t,F())?new Proxy(t,B):t)}function l(t){if(t instanceof IDBRequest)return j(t);if(D.has(t))return D.get(t);const e=k(t);return e!==t&&(D.set(t,e),m.set(e,t)),e}const g=t=>m.get(t);function _(t,e,{blocked:n,upgrade:r,blocking:a,terminated:i}={}){const s=indexedDB.open(t,e),d=l(s);return r&&s.addEventListener("upgradeneeded",o=>{r(l(s.result),o.oldVersion,o.newVersion,l(s.transaction),o)}),n&&s.addEventListener("blocked",o=>n(o.oldVersion,o.newVersion,o)),d.then(o=>{i&&o.addEventListener("close",()=>i()),a&&o.addEventListener("versionchange",u=>a(u.oldVersion,u.newVersion,u))}).catch(()=>{}),d}const K=["get","getKey","getAll","getAllKeys","count"],Y=["put","add","delete","clear"],y=new Map;function M(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(y.get(e))return y.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,a=Y.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(a||K.includes(n)))return;const i=async function(s,...d){const o=this.transaction(s,a?"readwrite":"readonly");let u=o.store;return r&&(u=u.index(d.shift())),(await Promise.all([u[n](...d),a&&o.done]))[0]};return y.set(e,i),i}W(t=>({...t,get:(e,n,r)=>M(e,n)||t.get(e,n,r),has:(e,n)=>!!M(e,n)||t.has(e,n)}));const G=["continue","continuePrimaryKey","advance"],P={},E=new WeakMap,x=new WeakMap,H={get(t,e){if(!G.includes(e))return t[e];let n=P[e];return n||(n=P[e]=function(...r){E.set(this,x.get(this)[e](...r))}),n}};async function*$(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,H);for(x.set(n,e),m.set(n,g(e));e;)yield n,e=await(E.get(n)||e.continue()),E.delete(n)}function N(t,e){return e===Symbol.asyncIterator&&R(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&R(t,[IDBIndex,IDBObjectStore])}W(t=>({...t,get(e,n,r){return N(e,n)?$:t.get(e,n,r)},has(e,n){return N(e,n)||t.has(e,n)}}));const h={FAIL:0,PASS:1},I={LEARNING:0,REVIEW:1},c={WORD:"word",TIMESTAMP:"timestamp",STATUS:"status",UID:"uid",TYPE:"type"};class q{constructor(){this.dbName="wordAppRecordDB",this.storeName="wordRecords",this.version=1}async initDB(){return _(this.dbName,this.version,{upgrade(e){if(!e.objectStoreNames.contains("wordRecords")){const n=e.createObjectStore("wordRecords",{keyPath:"id",autoIncrement:!0});n.createIndex("timestamp","timestamp",{unique:!1}),n.createIndex("word","word",{unique:!1})}}})}async addNewRecord(e,n,r=0,a=I.LEARNING){const i={[c.WORD]:e,[c.TIMESTAMP]:Date.now(),[c.STATUS]:n,[c.UID]:r,[c.TYPE]:a};return await this.addRecord(i)}async addRecord(e){return await(await this.initDB()).add(this.storeName,e)}async getRecordsByUid(e){return await(await this.initDB()).transaction(this.storeName).store.index("uid").getAll(e)}async getRecordsByWord(e){return await(await this.initDB()).transaction(this.storeName).store.index("word").getAll(e)}async getRecordsByTimeRange(e,n){return await(await this.initDB()).transaction(this.storeName).store.index("timestamp").getAll(IDBKeyRange.bound(e,n))}async deleteRecord(e){return await(await this.initDB()).delete(this.storeName,e)}async clearAllRecords(){return await(await this.initDB()).clear(this.storeName)}async getAllRecords(){return await(await this.initDB()).getAll(this.storeName)}async updateRecord(e){return await(await this.initDB()).put(this.storeName,e)}async importRecord(e){return await this.initDB(),(await this.getRecordsByWord(e[c.WORD])).length>0?await this.updateRecord(e):await this.addRecord(e)}async generateTestData(){await this.clearAllRecords();const e=["apple","banana","orange","grape","watermelon","computer","phone","laptop","tablet","keyboard","book","pen","pencil","notebook","dictionary","student","teacher","school","university","classroom","house","building","apartment","room","kitchen"],n=new Date,r=[];for(let d=0;d<30;d++){const o=new Date(n);o.setDate(o.getDate()-d);const u=Math.floor(Math.random()*11)+5,O=e.sort(()=>Math.random()-.5).slice(0,u);for(const S of O){const T=Math.random()>.3?h.PASS:h.FAIL,w=new Date(o);if(w.setHours(Math.floor(Math.random()*12)+8),r.push({[c.WORD]:S,[c.TIMESTAMP]:w.getTime(),[c.STATUS]:T,[c.UID]:0,[c.TYPE]:I.LEARNING}),T===h.PASS){const f=new Date(w);f.setHours(f.getHours()+Math.floor(Math.random()*4)+1);const C=Math.random()>.2?h.PASS:h.FAIL;r.push({[c.WORD]:S,[c.TIMESTAMP]:f.getTime(),[c.STATUS]:C,[c.UID]:0,[c.TYPE]:I.REVIEW})}}}r.sort((d,o)=>d.timestamp-o.timestamp);const i=(await this.initDB()).transaction(this.storeName,"readwrite"),s=i.objectStore(this.storeName);for(const d of r)await s.add(d);await i.done,console.log("测试数据生成完成，共生成",r.length,"条记录")}}const L=new q;function z(t){return console.log("addPassWordRecord",t),L.addNewRecord(t,h.PASS)}function J(t){return console.log("addFailWordRecord",t),L.addNewRecord(t,h.FAIL)}export{I as W,h as a,J as b,z as c,_ as o,L as w};
